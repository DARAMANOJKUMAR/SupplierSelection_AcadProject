<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplier Selection Tool</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font (Tailwind default often uses system fonts, this ensures Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .results-table-container {
            width: 100%;
        }
        .chart-container {
            position: relative;
            height: 300px; /* Fixed height for consistency */
            width: 100%;
        }
        @media (max-width: 640px) {
            .sm\:flex-row {
                flex-direction: column;
            }
        }
    </style>
    <!-- React and ReactDOM CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel CDN for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- PDF Generation Libraries CDNs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        // Global constants and helper functions outside the component scope
        const BACKEND_URL = 'https://supplierselection-acadproject-backend.onrender.com';

        const showMessageBox = (setMessageBox, title, message) => {
            setMessageBox({ show: true, title, message });
        };
        const closeMessageBox = (setMessageBox) => {
            setMessageBox({ show: false, title: '', message: '' });
        };

        const RadarChart = ({ supplierId, criteria, differenceMatrix }) => {
            const chartRef = React.useRef(null);
            const chartInstanceRef = React.useRef(null);

            React.useEffect(() => {
                if (!chartRef.current || !window.Chart) return;
                if (chartInstanceRef.current) chartInstanceRef.current.destroy();

                const labels = criteria.map(c => c.name);
                const dataPoints = criteria.map(c => differenceMatrix[supplierId]?.[c.id] || 0);
                const ctx = chartRef.current.getContext('2d');

                chartInstanceRef.current = new window.Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Performance Score',
                            data: dataPoints,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(59, 130, 246, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                angleLines: { display: true },
                                suggestedMin: -0.5,
                                suggestedMax: 0.5,
                                ticks: { beginAtZero: true, color: '#4b5563' },
                                pointLabels: { color: '#1f2937', font: { size: 10 } },
                                grid: { color: 'rgba(209, 213, 219, 0.5)' }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });

                return () => {
                    if (chartInstanceRef.current) chartInstanceRef.current.destroy();
                };
            }, [supplierId, criteria, differenceMatrix]);

            return <canvas ref={chartRef}></canvas>;
        };

        const HorizontalBarChartAcrossSuppliers = ({ selectedCriterionId, allSuppliers, allCriteria, gammaMatrix, chartTitle }) => {
            const chartRef = React.useRef(null);
            const chartInstanceRef = React.useRef(null);

            React.useEffect(() => {
                if (!chartRef.current || !window.Chart || !selectedCriterionId || !gammaMatrix) return;
                if (chartInstanceRef.current) chartInstanceRef.current.destroy();

                const labels = allSuppliers.map(s => s.name);
                const dataPoints = allSuppliers.map(s => gammaMatrix[s.id]?.[selectedCriterionId] || 0);
                const ctx = chartRef.current.getContext('2d');

                chartInstanceRef.current = new window.Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: chartTitle,
                            data: dataPoints,
                            backgroundColor: dataPoints.map(val => val >= 0 ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)'),
                            borderColor: dataPoints.map(val => val >= 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: false,
                                min: -0.3,
                                max: 0.5,
                                ticks: { color: '#4b5563' },
                                grid: { color: 'rgba(209, 213, 219, 0.5)' }
                            },
                            y: {
                                ticks: { color: '#1f2937' },
                                grid: { color: 'rgba(209, 213, 219, 0.5)' }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });

                return () => {
                    if (chartInstanceRef.current) chartInstanceRef.current.destroy();
                };
            }, [selectedCriterionId, allSuppliers, gammaMatrix, chartTitle]);

            return <canvas ref={chartRef}></canvas>;
        };

        const App = () => {
            const [suppliers, setSuppliers] = React.useState([{ id: 's1', name: 'Supplier A' }]);
            const [objectiveCriteria, setObjectiveCriteria] = React.useState([{ id: 'oc1', name: 'Quality Score', type: 'benefit' }, { id: 'oc2', name: 'Unit Cost', type: 'cost' }]);
            const [subjectiveRatingCriteria, setSubjectiveRatingCriteria] = React.useState([{ id: 'src1', name: 'Sustainability Rating', type: 'benefit' }, { id: 'src2', name: 'Relationship Quality', type: 'benefit' }]);
            const [objectiveData, setObjectiveData] = React.useState({ s1: { oc1: 90, oc2: 100, src1: 8, src2: 7 } });
            
            const [bwmComparisons, setBwmComparisons] = React.useState({ bestCriterionId: '', worstCriterionId: '', bestToOthers: {}, othersToWorst: {} });
            const [bwmCalculatedSubjectiveWeights, setBwmCalculatedSubjectiveWeights] = React.useState({});
            const [isCalculatingBWM, setIsCalculatingBWM] = React.useState(false);
            const [results, setResults] = React.useState(null);
            const [error, setError] = React.useState('');
            const [messageBox, setMessageBox] = React.useState({ show: false, title: '', message: '' });
            const [currentMethod, setCurrentMethod] = React.useState('GAPS');
            const [isPaperExampleMode, setIsPaperExampleMode] = React.useState(false);
            const [gapsPaperExampleWeights, setGapsPaperExampleWeights] = React.useState({ objective: {}, subjective: {}, integrated: {} });
            const [mabacPaperExampleWeights, setMabacPaperExampleWeights] = React.useState({ expert1: {}, expert2: {} });
            const [mabacWeightScenarioId, setMabacWeightScenarioId] = React.useState('expert1');
            const [selectedCriterionForChart, setSelectedCriterionForChart] = React.useState('');
            
            const allCriteria = [...objectiveCriteria, ...subjectiveRatingCriteria];
            
            const handleMessageBox = React.useCallback((title, message) => showMessageBox(setMessageBox, title, message), []);

            const handleCloseMessageBox = React.useCallback(() => closeMessageBox(setMessageBox), []);

            const addSupplier = () => {
                const newId = `s${suppliers.length + 1}`;
                setSuppliers([...suppliers, { id: newId, name: `Supplier ${String.fromCharCode(65 + suppliers.length)}` }]);
                setObjectiveData(prevData => {
                    const newSupplierData = {};
                    [...objectiveCriteria, ...subjectiveRatingCriteria].forEach(c => (newSupplierData[c.id] = 0));
                    return { ...prevData, [newId]: newSupplierData };
                });
                setIsPaperExampleMode(false);
                setResults(null);
            };

            const removeSupplier = (idToRemove) => {
                if (suppliers.length <= 1) {
                    handleMessageBox('Cannot Remove', 'You must have at least one supplier.');
                    return;
                }
                setSuppliers(suppliers.filter(s => s.id !== idToRemove));
                setObjectiveData(prevData => {
                    const newData = { ...prevData };
                    delete newData[idToRemove];
                    return newData;
                });
                setIsPaperExampleMode(false);
                setResults(null);
            };

            const handleSupplierNameChange = (id, newName) => {
                setSuppliers(suppliers.map(s => (s.id === id ? { ...s, name: newName } : s)));
            };

            const addCriterion = (type) => {
                let newId;
                let newCriterion;
                if (type === 'objective') {
                    newId = `oc${objectiveCriteria.length + 1}`;
                    newCriterion = { id: newId, name: `Objective Criterion ${objectiveCriteria.length + 1}`, type: 'benefit' };
                    setObjectiveCriteria(prev => [...prev, newCriterion]);
                } else {
                    newId = `src${subjectiveRatingCriteria.length + 1}`;
                    newCriterion = { id: newId, name: `Subjective Criterion ${subjectiveRatingCriteria.length + 1}`, type: 'benefit' };
                    setSubjectiveRatingCriteria(prev => [...prev, newCriterion]);
                }
                setObjectiveData(prevData => {
                    const newData = { ...prevData };
                    suppliers.forEach(s => {
                        newData[s.id] = { ...newData[s.id], [newId]: 0 };
                    });
                    return newData;
                });
                setIsPaperExampleMode(false);
                setResults(null);
            };

            const removeCriterion = (idToRemove, type) => {
                const currentAllCriteria = [...objectiveCriteria, ...subjectiveRatingCriteria];
                if (currentAllCriteria.length <= 1) {
                    handleMessageBox('Cannot Remove', 'You must have at least one criterion overall.');
                    return;
                }
                if (type === 'objective') {
                    setObjectiveCriteria(objectiveCriteria.filter(c => c.id !== idToRemove));
                } else {
                    setSubjectiveRatingCriteria(subjectiveRatingCriteria.filter(c => c.id !== idToRemove));
                }
                setObjectiveData(prevData => {
                    const newData = { ...prevData };
                    suppliers.forEach(s => {
                        const supplierData = { ...newData[s.id] };
                        delete supplierData[idToRemove];
                        newData[s.id] = supplierData;
                    });
                    return newData;
                });
                setBwmComparisons(prev => {
                    const newComparisons = {...prev};
                    if (newComparisons.bestCriterionId === idToRemove) newComparisons.bestCriterionId = '';
                    if (newComparisons.worstCriterionId === idToRemove) newComparisons.worstCriterionId = '';
                    newComparisons.bestToOthers = Object.fromEntries(Object.entries(newComparisons.bestToOthers).filter(([key]) => key !== idToRemove));
                    newComparisons.othersToWorst = Object.fromEntries(Object.entries(newComparisons.othersToWorst).filter(([key]) => key !== idToRemove));
                    return newComparisons;
                });
                setBwmCalculatedSubjectiveWeights({});
                setIsPaperExampleMode(false);
                setResults(null);
            };

            const handleCriterionChange = (id, field, value, type) => {
                if (type === 'objective') {
                    setObjectiveCriteria(objectiveCriteria.map(c => (c.id === id ? { ...c, [field]: value } : c)));
                } else {
                    setSubjectiveRatingCriteria(subjectiveRatingCriteria.map(c => (c.id === id ? { ...c, [field]: value } : c)));
                }
            };

            const handleObjectiveDataChange = (supplierId, criterionId, value) => {
                setObjectiveData(prevData => ({
                    ...prevData,
                    [supplierId]: {
                        ...prevData[supplierId],
                        [criterionId]: parseFloat(value) || 0,
                    },
                }));
                setIsPaperExampleMode(false);
                setResults(null);
            };
            
            const handleBWMComparisonChange = React.useCallback((field, value) => {
                setBwmComparisons(prev => ({ ...prev, [field]: value }));
                setBwmCalculatedSubjectiveWeights({});
                setResults(null);
            }, []);
            
            const handleBestToOthersChange = (criterionId, value) => {
                setBwmComparisons(prev => ({ ...prev, bestToOthers: { ...prev.bestToOthers, [criterionId]: parseInt(value) || 1 } }));
                setBwmCalculatedSubjectiveWeights({});
                setResults(null);
            };

            const handleOthersToWorstChange = (criterionId, value) => {
                setBwmComparisons(prev => ({ ...prev, othersToWorst: { ...prev.othersToWorst, [criterionId]: parseInt(value) || 1 } }));
                setBwmCalculatedSubjectiveWeights({});
                setResults(null);
            };
            
            const calculateBWMWeights = React.useCallback(async () => {
                setError('');
                const allCriteria = [...objectiveCriteria, ...subjectiveRatingCriteria];
                if (allCriteria.length < 2) {
                    handleMessageBox('BWM Error', 'BWM requires at least two criteria for comparison.');
                    return;
                }
                const { bestCriterionId, worstCriterionId } = bwmComparisons;
                if (!bestCriterionId || !worstCriterionId || bestCriterionId === worstCriterionId) {
                    handleMessageBox('BWM Error', 'Please select a Best and Worst Criterion that are different from each other.');
                    return;
                }

                setIsCalculatingBWM(true);
                setIsPaperExampleMode(false);
                setResults(null);
                try {
                    const payload = {
                        criteria_ids: allCriteria.map(c => c.id),
                        best_criterion_id: bestCriterionId,
                        worst_criterion_id: worstCriterionId,
                        best_to_others: bwmComparisons.bestToOthers,
                        others_to_worst: bwmComparisons.othersToWorst,
                    };
                    
                    const response = await fetch(`https://supplierselection-acadproject-backend.onrender.com/calculate_bwm_weights`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to calculate BWM weights.');
                    }

                    const data = await response.json();
                    setBwmCalculatedSubjectiveWeights(data.subjective_weights);
                    handleMessageBox('BWM Success', 'Subjective weights calculated successfully!');
                } catch (err) {
                    setError(`BWM Calculation Error: ${err.message}. Please ensure the Python backend is running and accessible.`);
                    setBwmCalculatedSubjectiveWeights({});
                } finally {
                    setIsCalculatingBWM(false);
                }
            }, [bwmComparisons, objectiveCriteria, subjectiveRatingCriteria, handleMessageBox]);

            React.useEffect(() => {
                const allCriteria = [...objectiveCriteria, ...subjectiveRatingCriteria];
                setBwmComparisons(prev => {
                    const initialBestToOthers = {};
                    const initialOthersToWorst = {};
                    allCriteria.forEach(c => {
                        initialBestToOthers[c.id] = prev.bestToOthers[c.id] || 1;
                        initialOthersToWorst[c.id] = prev.othersToWorst[c.id] || 1;
                    });
                    return { ...prev, bestToOthers: initialBestToOthers, othersToWorst: initialOthersToWorst };
                });
            }, [objectiveCriteria, subjectiveRatingCriteria]);
            
            const handleMabacWeightScenarioChange = (e) => {
                setMabacWeightScenarioId(e.target.value);
                setResults(null);
            };

            const handleSelectedCriterionForChartChange = (e) => {
                setSelectedCriterionForChart(e.target.value);
            };
            
            const calculateScores = React.useCallback(() => {
                setError('');
                const allCriteria = [...objectiveCriteria, ...subjectiveRatingCriteria];

                if (suppliers.length === 0 || allCriteria.length === 0) {
                    setError('Please add at least one supplier and one criterion.');
                    return;
                }

                let finalObjectiveWeights = {};
                let finalSubjectiveWeights = {};
                let finalIntegratedWeights = {};
                let calculatedAPS = {};
                let calculatedGammaMatrix = {};
                let calculatedDifferenceMatrix = {};
                let borderApproximationArea = {};
                let normalizedMatrix = {};
                let normalizedMatrixForEntropy = {};

                const criterionRawValues = {}; 
                allCriteria.forEach(c => {
                    criterionRawValues[c.id] = []; 
                    suppliers.forEach(s => {
                        const val = objectiveData[s.id]?.[c.id];
                        criterionRawValues[c.id].push(val === undefined ? 0 : val); 
                    });
                });

                if (isPaperExampleMode) {
                    if (currentMethod === 'GAPS') {
                        finalObjectiveWeights = gapsPaperExampleWeights.objective;
                        finalSubjectiveWeights = gapsPaperExampleWeights.subjective;
                        finalIntegratedWeights = gapsPaperExampleWeights.integrated;
                    } else if (currentMethod === 'MABAC') {
                        finalSubjectiveWeights = mabacPaperExampleWeights[mabacWeightScenarioId];
                        finalObjectiveWeights = {};
                        finalIntegratedWeights = finalSubjectiveWeights;
                    }
                } else {
                    const allBwmWeightsDefined = Object.keys(bwmCalculatedSubjectiveWeights).length > 0 && allCriteria.length > 0;
                    if (!allBwmWeightsDefined) {
                        setError('Please calculate subjective weights using BWM first.');
                        return;
                    }
                    finalSubjectiveWeights = bwmCalculatedSubjectiveWeights;
                    
                    allCriteria.forEach(c => {
                        const values = criterionRawValues[c.id];
                        const minVal = Math.min(...values);
                        const maxVal = Math.max(...values);
                        if (maxVal === minVal) {
                            suppliers.forEach(s => {
                                if (!normalizedMatrixForEntropy[s.id]) normalizedMatrixForEntropy[s.id] = {};
                                normalizedMatrixForEntropy[s.id][c.id] = 0;
                            });
                            return;
                        }
                        suppliers.forEach(s => {
                            const val = objectiveData[s.id]?.[c.id] || 0;
                            let normalizedVal;
                            if (c.type === 'benefit') {
                                normalizedVal = (val - minVal) / (maxVal - minVal);
                            } else {
                                normalizedVal = (maxVal - val) / (maxVal - minVal);
                            }
                            if (!normalizedMatrixForEntropy[s.id]) normalizedMatrixForEntropy[s.id] = {};
                            normalizedMatrixForEntropy[s.id][c.id] = normalizedVal;
                        });
                    });
                    
                    const lnN = Math.log(suppliers.length);
                    const informationEntropy = {};
                    const k = lnN === 0 ? 0 : -1 / lnN;
                    allCriteria.forEach(c => {
                        let sum_r_ln_r = 0;
                        suppliers.forEach(s => {
                            const r_val = normalizedMatrixForEntropy[s.id][c.id];
                            if (r_val > 0) {
                                sum_r_ln_r += r_val * Math.log(r_val);
                            }
                        });
                        informationEntropy[c.id] = k * sum_r_ln_r;
                    });
                    
                    const calculatedObjectiveWeights = {};
                    let sum_1_minus_Il = 0;
                    allCriteria.forEach(c => {
                        sum_1_minus_Il += (1 - informationEntropy[c.id]);
                    });
                    allCriteria.forEach(c => {
                        calculatedObjectiveWeights[c.id] = sum_1_minus_Il === 0 ? (1 / allCriteria.length) : (1 - informationEntropy[c.id]) / sum_1_minus_Il;
                    });
                    finalObjectiveWeights = calculatedObjectiveWeights;

                    if (currentMethod === 'GAPS') {
                        const calculatedIntegratedWeights = {};
                        let sum_wo_ws = 0;
                        allCriteria.forEach(c => {
                            const s_w = finalSubjectiveWeights[c.id] || 0;
                            sum_wo_ws += finalObjectiveWeights[c.id] * s_w;
                        });
                        allCriteria.forEach(c => {
                            const s_w = finalSubjectiveWeights[c.id] || 0;
                            calculatedIntegratedWeights[c.id] = sum_wo_ws === 0 ? (1 / allCriteria.length) : (finalObjectiveWeights[c.id] * s_w) / sum_wo_ws;
                        });
                        finalIntegratedWeights = calculatedIntegratedWeights;
                    } else if (currentMethod === 'MABAC') {
                        finalIntegratedWeights = finalSubjectiveWeights;
                    }
                }
                
                allCriteria.forEach(c => {
                    const values = criterionRawValues[c.id];
                    const minVal = Math.min(...values);
                    const maxVal = Math.max(...values);

                    if (maxVal === minVal) {
                        suppliers.forEach(s => {
                            if (!normalizedMatrix[s.id]) normalizedMatrix[s.id] = {};
                            normalizedMatrix[s.id][c.id] = 0;
                        });
                        return;
                    }

                    suppliers.forEach(s => {
                        const val = objectiveData[s.id]?.[c.id] || 0;
                        let normalizedVal;
                        if (c.type === 'benefit') {
                            normalizedVal = (val - minVal) / (maxVal - minVal);
                        } else {
                            normalizedVal = (maxVal - val) / (maxVal - minVal);
                        }
                        if (!normalizedMatrix[s.id]) normalizedMatrix[s.id] = {};
                        normalizedMatrix[s.id][c.id] = normalizedVal;
                    });
                });

                if (currentMethod === 'GAPS') {
                    const weightedNormalizedMatrix = {};
                    suppliers.forEach(s => {
                        weightedNormalizedMatrix[s.id] = {};
                        allCriteria.forEach(c => {
                            const valuesForNormalization = criterionRawValues[c.id];
                            const minVal = Math.min(...valuesForNormalization);
                            const maxVal = Math.max(...valuesForNormalization);
                            let currentNormalizedVal;
                            if (maxVal === minVal) {
                                currentNormalizedVal = 0;
                            } else {
                                const val = objectiveData[s.id]?.[c.id] || 0;
                                if (c.type === 'benefit') {
                                    currentNormalizedVal = (val - minVal) / (maxVal - minVal);
                                } else {
                                    currentNormalizedVal = (maxVal - val) / (maxVal - minVal);
                                }
                            }
                            weightedNormalizedMatrix[s.id][c.id] = currentNormalizedVal * (finalIntegratedWeights[c.id] || 0);
                        });
                    });

                    const geometricMeanMatrix = {};
                    allCriteria.forEach(c => {
                        let product = 1;
                        suppliers.forEach(s => {
                            product *= (weightedNormalizedMatrix[s.id][c.id] === 0 ? 0.000001 : weightedNormalizedMatrix[s.id][c.id]);
                        });
                        geometricMeanMatrix[c.id] = suppliers.length === 0 ? 0 : Math.pow(product, 1 / suppliers.length);
                    });

                    const differenceMatrix = {};
                    suppliers.forEach(s => {
                        differenceMatrix[s.id] = {};
                        allCriteria.forEach(c => {
                            differenceMatrix[s.id][c.id] = weightedNormalizedMatrix[s.id][c.id] - geometricMeanMatrix[c.id];
                        });
                    });
                    calculatedDifferenceMatrix = differenceMatrix;

                    const supplierScores = suppliers.map(s => {
                        let gaps = 0;
                        allCriteria.forEach(c => {
                            gaps += differenceMatrix[s.id][c.id];
                        });
                        return {
                            id: s.id,
                            name: s.name,
                            score: gaps,
                        };
                    }).sort((a, b) => b.score - a.score);

                    setResults({
                        method: 'GAPS',
                        normalizedMatrix: normalizedMatrix,
                        objectiveWeights: finalObjectiveWeights,
                        subjectiveWeights: finalSubjectiveWeights,
                        integratedWeights: finalIntegratedWeights,
                        weightedNormalizedMatrix,
                        geometricMeanMatrix,
                        differenceMatrix: calculatedDifferenceMatrix,
                        supplierScores,
                        gammaMatrix: null,
                        apsScores: null
                    });

                } else if (currentMethod === 'MABAC') {
                    const normalizedMABACMatrix = normalizedMatrix;

                    const weightedNormalizedMABACMatrix = {};
                    suppliers.forEach(s => {
                        weightedNormalizedMABACMatrix[s.id] = {};
                        allCriteria.forEach(c => {
                            const whz = finalSubjectiveWeights[c.id] || 0;
                            weightedNormalizedMABACMatrix[s.id][c.id] = whz * (normalizedMABACMatrix[s.id][c.id] + 1);
                        });
                    });

                    const borderApproximationArea = {};
                    allCriteria.forEach(c => {
                        let product = 1;
                        suppliers.forEach(s => {
                            product *= (weightedNormalizedMABACMatrix[s.id][c.id] === 0 ? 0.000001 : weightedNormalizedMABACMatrix[s.id][c.id]);
                        });
                        borderApproximationArea[c.id] = suppliers.length === 0 ? 0 : Math.pow(product, 1 / suppliers.length);
                    });

                    const gammaMatrix = {};
                    suppliers.forEach(s => {
                        gammaMatrix[s.id] = {};
                        allCriteria.forEach(c => {
                            gammaMatrix[s.id][c.id] = weightedNormalizedMABACMatrix[s.id][c.id] - borderApproximationArea[c.id];
                        });
                    });
                    calculatedGammaMatrix = gammaMatrix;

                    const apsScores = suppliers.map(s => {
                        let aps = 0;
                        allCriteria.forEach(c => {
                            aps += gammaMatrix[s.id][c.id];
                        });
                        return {
                            id: s.id,
                            name: s.name,
                            score: aps,
                        };
                    }).sort((a, b) => b.score - a.score);
                    calculatedAPS = apsScores;
                    
                    const finalSubjectiveWeightsForMabac = isPaperExampleMode ? mabacPaperExampleWeights[mabacWeightScenarioId] : finalSubjectiveWeights;
                    
                    setResults({
                        method: 'MABAC',
                        normalizedMatrix: normalizedMABACMatrix,
                        objectiveWeights: finalObjectiveWeights,
                        subjectiveWeights: finalSubjectiveWeightsForMabac,
                        integratedWeights: finalSubjectiveWeightsForMabac,
                        weightedNormalizedMatrix: weightedNormalizedMABACMatrix,
                        geometricMeanMatrix: {},
                        differenceMatrix: null,
                        supplierScores: calculatedAPS,
                        gammaMatrix: calculatedGammaMatrix,
                        apsScores: calculatedAPS,
                        borderApproximationArea: borderApproximationArea
                    });
                }

            }, [suppliers, objectiveCriteria, subjectiveRatingCriteria, objectiveData, bwmCalculatedSubjectiveWeights, isPaperExampleMode, gapsPaperExampleWeights, mabacPaperExampleWeights, mabacWeightScenarioId, currentMethod]);

            React.useEffect(() => {
                if ((Object.keys(bwmCalculatedSubjectiveWeights).length > 0 && !isPaperExampleMode) || isPaperExampleMode || [...objectiveCriteria, ...subjectiveRatingCriteria].length === 0) {
                    calculateScores();
                }
            }, [calculateScores, bwmCalculatedSubjectiveWeights, isPaperExampleMode, objectiveCriteria, subjectiveRatingCriteria]);
            
            React.useEffect(() => {
                if (isPaperExampleMode && currentMethod === 'MABAC' && results && results.gammaMatrix) {
                    const mabacCriteria = allCriteria.filter(c => mabacPaperExampleWeights.expert1[c.id] !== undefined);
                    const firstCriterionId = mabacCriteria.length > 0 ? mabacCriteria[0].id : '';
                    setSelectedCriterionForChart(firstCriterionId);
                }
            }, [isPaperExampleMode, currentMethod, results, mabacPaperExampleWeights]);


            const allCriteria = [...objectiveCriteria, ...subjectiveRatingCriteria];
            const allMabacCriteria = [...objectiveCriteria, ...subjectiveRatingCriteria].filter(c => ['pt', 'dr', 'ci', 'ta', 'g', 'fm', 'r'].includes(c.id));

            const loadGAPSExample = () => {
                setError('');
                setResults(null);
                setBwmCalculatedSubjectiveWeights({});
                setBwmComparisons({ bestCriterionId: '', worstCriterionId: '', bestToOthers: {}, othersToWorst: {} });
                
                const exampleSuppliers = [
                    { id: 'atl', name: 'ATL (Hartsfield-Jackson Atlanta Int.)' },
                    { id: 'pek', name: 'PEK (Beijing Capital Int.)' },
                    { id: 'lax', name: 'LAX (Los Angeles Int.)' },
                ];
                setSuppliers(exampleSuppliers);

                const exampleObjectiveCriteria = [
                    { id: 'pt', name: 'Passenger Throughput (PT)', type: 'benefit' },
                    { id: 'am', name: 'Aircraft Movement (AM)', type: 'benefit' },
                    { id: 'ct', name: 'Cargo Throughput (CT)', type: 'benefit' },
                    { id: 'dc', name: 'Degree Centrality (DC)', type: 'benefit' },
                    { id: 'bc', name: 'Betweenness Centrality (BC)', type: 'benefit' },
                ];
                setObjectiveCriteria(exampleObjectiveCriteria);
                setSubjectiveRatingCriteria([]);

                const exampleObjectiveData = {
                    atl: { pt: 110531300, am: 904301, ct: 640276, dc: 272, bc: 151608 },
                    pek: { pt: 100011438, am: 594329, ct: 1957779, dc: 256, bc: 329324 },
                    lax: { pt: 88068013, am: 691257, ct: 2518053, dc: 237, bc: 286551 },
                };
                setObjectiveData(exampleObjectiveData);

                const paperObjWeights = { pt: 0.30, am: 0.18, ct: 0.27, dc: 0.13, bc: 0.12 };
                const paperSubjWeights = { pt: 0.29, am: 0.16, ct: 0.26, dc: 0.20, bc: 0.09 };
                const paperIntWeights = { pt: 0.38, am: 0.13, ct: 0.32, dc: 0.12, bc: 0.05 };
                setGapsPaperExampleWeights({ objective: paperObjWeights, subjective: paperSubjWeights, integrated: paperIntWeights });

                setIsPaperExampleMode(true);
                setCurrentMethod('GAPS');
                showMessageBox('GAPS Paper Example Loaded', 'Data and weights from the first research paper (ATL, PEK, LAX) have been loaded. Click "Calculate Supplier Scores" to see results matching the paper.');
            };

            // --- Function to Load Paper Example (MABAC) ---
            const loadMABACExample = () => {
                setError('');
                setResults(null);
                setBwmCalculatedSubjectiveWeights({});
                setBwmComparisons({ bestCriterionId: '', worstCriterionId: '', bestToOthers: {}, othersToWorst: {} });

                const exampleSuppliers = [
                    { id: 'pek', name: 'PEK (Beijing Capital Int.)' }, { id: 'csx', name: 'CSX (Changsha Huanghua Int.)' },
                    { id: 'ctu', name: 'CTU (Chengdu Shuangliu Int.)' }, { id: 'dlc', name: 'DLC (Dalian Zhoushuizi Int.)' },
                    { id: 'foc', name: 'FOC (Fuzhou Changle Int.)' }, { id: 'can', name: 'CAN (Guangzhou Baiyun Int.)' },
                    { id: 'het', name: 'HET (Hohhot Baita Int.)' }, { id: 'kmg', name: 'KMG (Kunming Changshui Int.)' },
                    { id: 'lhw', name: 'LHW (Lanzhou Zhongchuan Int.)' }, { id: 'lxa', name: 'LXA (Lhasa Kongga Int.)' },
                    { id: 'nkg', name: 'NKG (Nanjing Lukou Int.)' }, { id: 'ngb', name: 'NGB (Ningbo Lishe Int.)' },
                    { id: 'tao', name: 'TAO (Qingdao Liuting Int.)' }, { id: 'sha', name: 'SHA (Shanghai Hongqiao Int.)' },
                    { id: 'szx', name: 'SZX (Shenzhen Bao\'an Int.)' }, { id: 'xiy', name: 'XIY (Xi\'an Xianyang Int.)' },
                    { id: 'cgo', name: 'CGO (Zhengzhou Xinzheng Int.)' },
                ];
                setSuppliers(exampleSuppliers);

                const exampleObjectiveCriteria = [
                    { id: 'pt', name: 'Passenger Throughput (PT)', type: 'benefit' }, { id: 'dr', name: 'No. of Direct Routes (DR)', type: 'benefit' },
                    { id: 'ci', name: 'No. of Check-in Counters (CI)', type: 'benefit' }, { id: 'ta', name: 'Terminal Area (TA)', type: 'benefit' },
                    { id: 'g', name: 'No. of Gates (G)', type: 'benefit' }, { id: 'fm', name: 'No. of Flights (FM)', type: 'benefit' },
                    { id: 'r', name: 'No. of Runways (R)', type: 'benefit' },
                ];
                setObjectiveCriteria(exampleObjectiveCriteria);
                setSubjectiveRatingCriteria([]);

                const exampleObjectiveData = {
                    pek: { pt: 100013642, dr: 458, ci: 577, ta: 1410000, g: 195, fm: 594329, r: 3 },
                    csx: { pt: 26911393, dr: 193, ci: 102, ta: 212000, g: 32, fm: 196213, r: 1 },
                    ctu: { pt: 55858552, dr: 323, ci: 201, ta: 500000, g: 110, fm: 366887, r: 2 },
                    dlc: { pt: 20079995, dr: 162, ci: 93, ta: 135000, g: 18, fm: 154976, r: 1 },
                    foc: { pt: 14760226, dr: 103, ci: 39, ta: 216000, g: 54, fm: 112746, r: 1 },
                    can: { pt: 73378475, dr: 328, ci: 644, ta: 1403700, g: 204, fm: 491249, r: 3 },
                    het: { pt: 13151840, dr: 113, ci: 40, ta: 54400, g: 29, fm: 112159, r: 2 },
                    kmg: { pt: 48075978, dr: 306, ci: 160, ta: 548300, g: 84, fm: 357080, r: 2 },
                    lhw: { pt: 15302975, dr: 126, ci: 50, ta: 90000, g: 20, fm: 119183, r: 1 },
                    lxa: { pt: 4572428, dr: 44, ci: 16, ta: 25000, g: 4, fm: 39065, r: 1 },
                    nkg: { pt: 30581685, dr: 199, ci: 112, ta: 425000, g: 42, fm: 234869, r: 2 },
                    ngb: { pt: 12414007, dr: 101, ci: 34, ta: 43500, g: 28, fm: 89487, r: 1 },
                    tao: { pt: 25556278, dr: 174, ci: 97, ta: 120000, g: 22, fm: 186500, r: 1 },
                    sha: { pt: 45637882, dr: 187, ci: 188, ta: 444600, g: 102, fm: 272928, r: 2 },
                    szx: { pt: 52931925, dr: 247, ci: 192, ta: 451000, g: 82, fm: 370180, r: 2 },
                    xiy: { pt: 47220547, dr: 297, ci: 140, ta: 350000, g: 74, fm: 345748, r: 2 },
                    cgo: { pt: 29129328, dr: 198, ci: 154, ta: 620000, g: 70, fm: 216399, r: 1 },
                };
                setObjectiveData(exampleObjectiveData);

                const expert1Weights = { pt: 0.359, dr: 0.139, ci: 0.083, ta: 0.104, g: 0.069, fm: 0.209, r: 0.033 };
                const expert2Weights = { pt: 0.211, dr: 0.141, ci: 0.052, ta: 0.128, g: 0.070, fm: 0.361, r: 0.033 };
                setMabacPaperExampleWeights({ expert1: expert1Weights, expert2: expert2Weights });
                setMabacWeightScenarioId('expert1');

                setIsPaperExampleMode(true);
                setCurrentMethod('MABAC');
                setSelectedCriterionForChart('pt');
                showMessageBox('MABAC Paper Example Loaded', 'Data and weights from the second research paper (Chinese airports) have been loaded. Select a Weight Scenario and Criterion to visualize, then click "Calculate Supplier Scores".');
            };


            const exportResultsToPdf = () => {
                if (typeof window.html2canvas === 'undefined' || typeof window.jspdf === 'undefined') {
                    showMessageBox('Export Error', 'PDF generation libraries are not loaded. Please ensure internet connectivity or try again.');
                    console.error("PDF generation error:", err);
                    return;
                }

                const input = document.getElementById('results-section');
                if (!input) {
                    showMessageBox('Export Error', 'Results section not found. Please calculate results first.');
                    return;
                }

                const exportButton = document.getElementById('export-pdf-button');
                if (exportButton) exportButton.style.display = 'none';

                window.html2canvas(input, { scale: 2 })
                    .then((canvas) => {
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                        const imgWidth = 210;
                        const pageHeight = 297;
                        let heightLeft = imgHeight;
                        let position = 0;

                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;

                        while (heightLeft >= 0) {
                            position = heightLeft - imgHeight;
                            pdf.addPage();
                            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                            heightLeft -= pageHeight;
                        }

                        pdf.save('Supplier_Selection_Results.pdf');
                    })
                    .catch(err => {
                        showMessageBox('Export Error', `Failed to generate PDF: ${err.message}`);
                        console.error("PDF generation error:", err);
                    })
                    .finally(() => {
                        if (exportButton) exportButton.style.display = 'block';
                    });
            };


            return (
                <div className="min-h-screen bg-gray-50 font-inter p-4 sm:p-6 lg:p-8">
                    <div className="max-w-7xl mx-auto bg-white shadow-lg rounded-xl p-6 sm:p-8">
                        <h1 className="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-6 text-center">
                            Supplier Selection Tool
                        </h1>
                        {error && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative mb-4" role="alert">
                                <strong className="font-bold">Error!</strong>
                                <span className="block sm:inline"> {error}</span>
                            </div>
                        )}

                        {/* Message Box Modal */}
                        {messageBox.show && (
                            <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
                                <div className="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                                    <h2 className="text-xl font-bold mb-4 text-gray-900">{messageBox.title}</h2>
                                    <p className="text-gray-700 mb-6">{messageBox.message}</p>
                                    <button
                                        onClick={closeMessageBox}
                                        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out"
                                    >
                                        OK
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Methodology Selection Buttons */}
                        <div className="text-center mb-8 flex flex-col sm:flex-row justify-center gap-4">
                            <button
                                onClick={() => {
                                    setCurrentMethod('GAPS');
                                    setIsPaperExampleMode(false);
                                    setResults(null);
                                    setError('');
                                }}
                                className={`flex-1 max-w-xs bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out ${currentMethod === 'GAPS' && !isPaperExampleMode ? 'ring-2 ring-indigo-700' : ''}`}
                            >
                                Custom GAPS Calculation
                            </button>
                            <button
                                onClick={() => {
                                    setCurrentMethod('MABAC');
                                    setIsPaperExampleMode(false);
                                    setResults(null);
                                    setError('');
                                }}
                                className={`flex-1 max-w-xs bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out ${currentMethod === 'MABAC' && !isPaperExampleMode ? 'ring-2 ring-purple-700' : ''}`}
                            >
                                Custom MABAC Calculation
                            </button>
                        </div>


                        {/* Paper Example Load Buttons */}
                        <div className="text-center mb-8 flex flex-col sm:flex-row justify-center gap-4">
                            <button
                                onClick={loadGAPSExample}
                                className={`flex-1 max-w-xs bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-md shadow-lg transform transition duration-300 ease-in-out hover:scale-105 ${isPaperExampleMode && currentMethod === 'GAPS' ? 'ring-2 ring-orange-700' : ''}`}
                            >
                                Load Paper Example (GAPS)
                            </button>
                            <button
                                onClick={loadMABACExample}
                                className={`flex-1 max-w-xs bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-md shadow-lg transform transition duration-300 ease-in-out hover:scale-105 ${isPaperExampleMode && currentMethod === 'MABAC' ? 'ring-2 ring-teal-700' : ''}`}
                            >
                                Load Paper Example (MABAC)
                            </button>
                        </div>
                        {isPaperExampleMode && (
                            <p className="text-sm text-orange-700 mb-4 text-center">
                                *Currently in Paper Example Mode for {currentMethod}. Data and weights are pre-set from the paper for validation.*
                            </p>
                        )}


                        {/* Supplier Management Section */}
                        <div className="mb-8 p-6 bg-blue-50 rounded-lg shadow-inner">
                            <h2 className="text-2xl font-semibold text-blue-800 mb-4 flex items-center">
                                <svg className="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H2v-2a3 3 0 015.356-1.857M17 20v-2c0-.185-.015-.369-.044-.552m0 0A3 3 0 0014.854 10.5h-1.298a3 3 0 00-.776-1.63L10.99 7.462m0 0a3 3 0 00-4.243 0L4.293 9.707A3 3 0 003 12.5v2m0 0c-.185-.015-.369-.044-.552-.044m0 0A3 3 0 001.5 10.5h-1.298a3 3 0 00-.776-1.63L-1.01 7.462m0 0a3 3 0 00-4.243 0L-7.707 9.707A3 3 0 00-9 12.5v2"></path></svg>
                                Manage Suppliers
                            </h2>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                                {suppliers.map(s => (
                                    <div key={s.id} className="flex items-center bg-white p-3 rounded-md shadow-sm border border-blue-200">
                                        <input
                                            type="text"
                                            value={s.name}
                                            onChange={(e) => handleSupplierNameChange(s.id, e.target.value)}
                                            className="flex-grow border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 mr-2 p-2 text-sm"
                                            placeholder="Supplier Name"
                                            disabled={isPaperExampleMode}
                                        />
                                        <button
                                            onClick={() => removeSupplier(s.id)}
                                            className="bg-red-500 hover:bg-red-600 text-white p-2 rounded-md transition duration-300 ease-in-out text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                            title="Remove Supplier"
                                            disabled={isPaperExampleMode}
                                        >
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        </button>
                                    </div>
                                ))}
                            </div>
                            <button
                                onClick={addSupplier}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled={isPaperExampleMode}
                            >
                                <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                Add Supplier
                            </button>
                        </div>

                        {/* Objective Criteria Management Section */}
                        <div className="mb-8 p-6 bg-green-50 rounded-lg shadow-inner">
                            <h2 className="text-2xl font-semibold text-green-800 mb-4 flex items-center">
                                <svg className="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 17v-2m3 2v-4m3 2v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                Manage Objective Criteria (Numerical Data)
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                {objectiveCriteria.map(c => (
                                    <div key={c.id} className="flex flex-col bg-white p-3 rounded-md shadow-sm border border-green-200">
                                        <div className="flex items-center mb-2">
                                            <input
                                                type="text"
                                                value={c.name}
                                                onChange={(e) => handleCriterionChange(c.id, 'name', e.target.value, 'objective')}
                                                className="flex-grow border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 mr-2 p-2 text-sm"
                                                placeholder="Criterion Name"
                                                disabled={isPaperExampleMode}
                                            />
                                            <button
                                                onClick={() => removeCriterion(c.id, 'objective')}
                                                className="bg-red-500 hover:bg-red-600 text-white p-2 rounded-md transition duration-300 ease-in-out text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                                title="Remove Criterion"
                                                disabled={isPaperExampleMode}
                                            >
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                            </button>
                                        </div>
                                        <div className="flex items-center mb-2 text-sm text-gray-700">
                                            <span className="mr-2">Type:</span>
                                            <label className="inline-flex items-center mr-3">
                                                <input
                                                    type="radio"
                                                    className="form-radio text-green-600"
                                                    name={`type-${c.id}`}
                                                    value="benefit"
                                                    checked={c.type === 'benefit'}
                                                    onChange={() => handleCriterionChange(c.id, 'type', 'benefit', 'objective')}
                                                    disabled={isPaperExampleMode}
                                                />
                                                <span className="ml-1">Benefit (Higher is Better)</span>
                                            </label>
                                            <label className="inline-flex items-center">
                                                <input
                                                    type="radio"
                                                    className="form-radio text-green-600"
                                                    name={`type-${c.id}`}
                                                    value="cost"
                                                    checked={c.type === 'cost'}
                                                    onChange={() => handleCriterionChange(c.id, 'type', 'cost', 'objective')}
                                                    disabled={isPaperExampleMode}
                                                />
                                                <span className="ml-1">Cost (Lower is Better)</span>
                                            </label>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <button
                                onClick={() => addCriterion('objective')}
                                className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled={isPaperExampleMode}
                            >
                                <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                Add Objective Criterion
                            </button>
                        </div>

                        {/* Subjective Rating Criteria Management Section */}
                        <div className="mb-8 p-6 bg-purple-50 rounded-lg shadow-inner">
                            <h2 className="text-2xl font-semibold text-purple-800 mb-4 flex items-center">
                                <svg className="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                Manage Subjective Rating Criteria (User Ratings)
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                {subjectiveRatingCriteria.map(c => (
                                    <div key={c.id} className="flex flex-col bg-white p-3 rounded-md shadow-sm border border-purple-200">
                                        <div className="flex items-center mb-2">
                                            <input
                                                type="text"
                                                value={c.name}
                                                onChange={(e) => handleCriterionChange(c.id, 'name', e.target.value, 'subjectiveRating')}
                                                className="flex-grow border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 mr-2 p-2 text-sm"
                                                placeholder="Criterion Name"
                                                disabled={isPaperExampleMode}
                                            />
                                            <button
                                                onClick={() => removeCriterion(c.id, 'subjectiveRating')}
                                                className="bg-red-500 hover:bg-red-600 text-white p-2 rounded-md transition duration-300 ease-in-out text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                                title="Remove Criterion"
                                                disabled={isPaperExampleMode}
                                            >
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                            </button>
                                        </div>
                                        <div className="flex items-center mb-2 text-sm text-gray-700">
                                            <span className="mr-2">Type:</span>
                                            <label className="inline-flex items-center mr-3">
                                                <input
                                                    type="radio"
                                                    className="form-radio text-purple-600"
                                                    name={`type-${c.id}`}
                                                    value="benefit"
                                                    checked={c.type === 'benefit'}
                                                    onChange={() => handleCriterionChange(c.id, 'type', 'benefit', 'subjectiveRating')}
                                                    disabled={isPaperExampleMode}
                                                />
                                                <span className="ml-1">Benefit (Higher is Better)</span>
                                            </label>
                                            <label className="inline-flex items-center">
                                                <input
                                                    type="radio"
                                                    className="form-radio text-purple-600"
                                                    name={`type-${c.id}`}
                                                    value="cost"
                                                    checked={c.type === 'cost'}
                                                    onChange={() => handleCriterionChange(c.id, 'type', 'cost', 'subjectiveRating')}
                                                    disabled={isPaperExampleMode}
                                                />
                                                <span className="ml-1">Cost (Lower is Better)</span>
                                            </label>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <button
                                onClick={() => addCriterion('subjectiveRating')}
                                className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled={isPaperExampleMode}
                            >
                                <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                Add Subjective Rating Criterion
                            </button>
                        </div>

                        {/* BWM Input Section */}
                        <div className="mb-8 p-6 bg-red-50 rounded-lg shadow-inner">
                            <h2 className="text-2xl font-semibold text-red-800 mb-4 flex items-center">
                                <svg className="w-6 h-6 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                Subjective Weight Calculation (Best-Worst Method)
                            </h2>
                            <p className="text-sm text-gray-600 mb-4">
                                *This method uses a backend to perform a mathematically rigorous optimization for subjective weights.*
                                <br />
                                **Note:** Charts update after clicking this button and then "Calculate Supplier Scores".
                            </p>
                            
                            <div className="mb-4">
                                <label htmlFor="best-criterion" className="block text-sm font-medium text-gray-700 mb-1">Select Best Criterion:</label>
                                <select
                                    id="best-criterion"
                                    className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md"
                                    value={bwmComparisons.bestCriterionId}
                                    onChange={(e) => handleBWMComparisonChange('bestCriterionId', e.target.value)}
                                    disabled={isPaperExampleMode}
                                >
                                    <option value="">-- Select --</option>
                                    {allCriteria.map(c => (
                                        <option key={c.id} value={c.id}>{c.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="mb-4">
                                <label htmlFor="worst-criterion" className="block text-sm font-medium text-gray-700 mb-1">Select Worst Criterion:</label>
                                <select
                                    id="worst-criterion"
                                    className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md"
                                    value={bwmComparisons.worstCriterionId}
                                    onChange={(e) => handleBWMComparisonChange('worstCriterionId', e.target.value)}
                                    disabled={isPaperExampleMode}
                                >
                                    <option value="">-- Select --</option>
                                    {allCriteria.map(c => (
                                        <option key={c.id} value={c.id}>{c.name}</option>
                                    ))}
                                </select>
                            </div>

                            {bwmComparisons.bestCriterionId && (
                                <div className="mb-4 p-3 bg-red-200 rounded-md">
                                    <h3 className="text-md font-semibold text-red-800 mb-2">Best-to-Others Comparisons</h3>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        {allCriteria.filter(c => c.id !== bwmComparisons.bestCriterionId).map(c => (
                                            <div key={c.id} className="flex items-center justify-between bg-white p-2 rounded-md shadow-sm">
                                                <label className="text-sm text-gray-700 mr-2">{c.name}:</label>
                                                <input
                                                    type="number"
                                                    min="1"
                                                    max="9"
                                                    value={bwmComparisons.bestToOthers[c.id] || 1}
                                                    onChange={(e) => handleBestToOthersChange(c.id, e.target.value)}
                                                    className="w-20 border-gray-300 rounded-md shadow-sm p-1 text-sm text-center"
                                                    disabled={isPaperExampleMode}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {bwmComparisons.worstCriterionId && (
                                <div className="p-3 bg-red-200 rounded-md">
                                    <h3 className="text-md font-semibold text-red-800 mb-2">Others-to-Worst Comparisons</h3>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        {allCriteria.filter(c => c.id !== bwmComparisons.worstCriterionId).map(c => (
                                            <div key={c.id} className="flex items-center justify-between bg-white p-2 rounded-md shadow-sm">
                                                <label className="text-sm text-gray-700 mr-2">{c.name}:</label>
                                                <input
                                                    type="number"
                                                    min="1"
                                                    max="9"
                                                    value={bwmComparisons.othersToWorst[c.id] || 1}
                                                    onChange={(e) => handleOthersToWorstChange(c.id, e.target.value)}
                                                    className="w-20 border-gray-300 rounded-md shadow-sm p-1 text-sm text-center"
                                                    disabled={isPaperExampleMode}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <button
                                onClick={calculateBWMWeights}
                                disabled={isCalculatingBWM || isPaperExampleMode}
                                className={`w-full mt-4 ${isCalculatingBWM || isPaperExampleMode ? 'bg-gray-400 cursor-not-allowed' : 'bg-red-600 hover:bg-red-700'} text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out flex items-center justify-center`}
                            >
                                {isCalculatingBWM ? (
                                    <>
                                        <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        Calculating Subjective Weights...
                                    </>
                                ) : (
                                    <>
                                        <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                        Calculate Subjective Weights (BWM)
                                    </>
                                )}
                            </button>
                            {Object.keys(bwmCalculatedSubjectiveWeights).length > 0 && !isPaperExampleMode && (
                                <div className="mt-4 p-3 bg-red-100 rounded-md">
                                    <h3 className="text-lg font-semibold text-red-700 mb-2">Calculated Subjective Weights:</h3>
                                    <ul className="list-disc list-inside text-gray-700">
                                        {allCriteria.map(c => (
                                            <li key={c.id}>{c.name}: {bwmCalculatedSubjectiveWeights[c.id]?.toFixed(4)}</li>
                                        ))}
                                    </ul>
                                </div>
                            )}
                        </div>


                        {/* Objective Data Input Table */}
                        <div className="mb-8 p-6 bg-yellow-50 rounded-lg shadow-inner overflow-x-auto">
                            <h2 className="text-2xl font-semibold text-yellow-800 mb-4 flex items-center">
                                <svg className="w-6 h-6 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                Input Data
                            </h2>
                            <div className="overflow-x-auto">
                                <table className="min-w-full bg-white rounded-md shadow-sm">
                                    <thead>
                                        <tr className="bg-yellow-100 text-yellow-900 uppercase text-sm leading-normal">
                                            <th className="py-3 px-6 text-left rounded-tl-md">Supplier</th>
                                            {allCriteria.map(c => (
                                                <th key={c.id} className="py-3 px-6 text-center">{c.name}</th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody className="text-gray-700 text-sm">
                                        {suppliers.map(s => (
                                            <tr key={s.id} className="border-b border-gray-200 hover:bg-gray-50">
                                                <td className="py-3 px-6 text-left whitespace-nowrap font-medium">{s.name}</td>
                                                {allCriteria.map(c => (
                                                    <td key={c.id} className="py-3 px-6 text-center">
                                                        <input
                                                            type="number"
                                                            value={objectiveData[s.id]?.[c.id] || ''}
                                                            onChange={(e) => handleObjectiveDataChange(s.id, c.id, e.target.value)}
                                                            className="w-24 border-gray-300 rounded-md shadow-sm focus:ring-yellow-500 focus:border-yellow-500 p-2 text-sm text-center"
                                                            placeholder="Value"
                                                            disabled={isPaperExampleMode}
                                                        />
                                                    </td>
                                                ))}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Calculation Trigger */}
                        <div className="text-center mb-8">
                            <button
                                onClick={calculateScores}
                                className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-md shadow-lg transform transition duration-300 ease-in-out hover:scale-105"
                            >
                                Calculate Supplier Scores
                            </button>
                        </div>

                        {/* Results Section */}
                        {results && (
                            <div id="results-section" className="p-6 bg-blue-50 rounded-lg shadow-inner">
                                <h2 className="text-2xl font-semibold text-blue-800 mb-4 flex items-center">
                                    <svg className="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Calculation Results
                                </h2>
                                {results.supplierScores.length > 0 && (
                                    <h4 className="text-xl font-semibold text-green-700 mb-4">
                                        The best performing supplier is: {results.supplierScores[0].name}
                                    </h4>
                                )}
                                
                                {/* Weights for MABAC Example */}
                                {isPaperExampleMode && currentMethod === 'MABAC' && (
                                    <div className="mb-4 p-3 bg-teal-100 rounded-md">
                                        <h3 className="text-lg font-semibold text-teal-700 mb-2">MABAC Weight Scenario:</h3>
                                        <div className="flex items-center space-x-4">
                                            <label className="inline-flex items-center">
                                                <input
                                                    type="radio"
                                                    className="form-radio text-teal-600"
                                                    name="mabacWeightScenario"
                                                    value="expert1"
                                                    checked={mabacWeightScenarioId === 'expert1'}
                                                    onChange={(e) => {
                                                        setMabacWeightScenarioId(e.target.value);
                                                        setResults(null);
                                                    }}
                                                />
                                                <span className="ml-1 text-sm text-gray-700">Expert 1 (PT Most Important)</span>
                                            </label>
                                            <label className="inline-flex items-center">
                                                <input
                                                    type="radio"
                                                    className="form-radio text-teal-600"
                                                    name="mabacWeightScenario"
                                                    value="expert2"
                                                    checked={mabacWeightScenarioId === 'expert2'}
                                                    onChange={(e) => {
                                                        setMabacWeightScenarioId(e.target.value);
                                                        setResults(null);
                                                    }}
                                                />
                                                <span className="ml-1 text-sm text-gray-700">Expert 2 (FM Most Important)</span>
                                            </label>
                                        </div>
                                    </div>
                                )}


                                {/* Supplier Ranking */}
                                <h3 className="text-xl font-medium text-blue-700 mb-3 mt-6">Supplier Ranking ({results.method === 'GAPS' ? 'GAPS' : 'APS'} Score)</h3>
                                <div className="overflow-x-auto mb-6">
                                    <table className="min-w-full bg-white rounded-md shadow-sm">
                                        <thead>
                                            <tr className="bg-blue-100 text-blue-900 uppercase text-sm leading-normal">
                                                <th className="py-3 px-6 text-left rounded-tl-md">Rank</th>
                                                <th className="py-3 px-6 text-left">Supplier</th>
                                                <th className="py-3 px-6 text-right rounded-tr-md">{results.method === 'GAPS' ? 'GAPS' : 'APS'} Score</th>
                                            </tr>
                                        </thead>
                                        <tbody className="text-gray-700 text-sm">
                                            {results.supplierScores.map((s, index) => (
                                                <tr key={s.id} className="border-b border-gray-200 hover:bg-gray-50">
                                                    <td className="py-3 px-6 text-left font-bold">{index + 1}</td>
                                                    <td className="py-3 px-6 text-left">{s.name}</td>
                                                    <td className="py-3 px-6 text-right">{s.score.toFixed(4)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                {/* Weights Breakdown */}
                                <h3 className="text-xl font-medium text-blue-700 mb-3 mt-6">Criteria Weights</h3>
                                <div className="overflow-x-auto mb-6">
                                    <table className="min-w-full bg-white rounded-md shadow-sm">
                                        <thead>
                                            <tr className="bg-blue-100 text-blue-900 uppercase text-sm leading-normal">
                                                <th className="py-3 px-6 text-left rounded-tl-md">Criterion</th>
                                                <th className="py-3 px-6 text-right">Objective Weight</th>
                                                <th className="py-3 px-6 text-right">Subjective Weight</th>
                                                <th className="py-3 px-6 text-right">Integrated Weight</th>
                                            </tr>
                                        </thead>
                                        <tbody className="text-gray-700 text-sm">
                                            {allCriteria.map(c => (
                                                <tr key={c.id} className="border-b border-gray-200 hover:bg-gray-50">
                                                    <td className="py-3 px-6 text-left">{c.name}</td>
                                                    <td className="py-3 px-6 text-right">{results.objectiveWeights[c.id]?.toFixed(4)}</td>
                                                    <td className="py-3 px-6 text-right">{results.subjectiveWeights[c.id]?.toFixed(4)}</td>
                                                    <td className="py-3 px-6 text-right font-bold">{results.integratedWeights[c.id]?.toFixed(4)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                {/* Dynamic Charts */}
                                <h3 className="text-xl font-medium text-blue-700 mb-3 mt-6">Individual Supplier Performance Charts</h3>
                                <p className="text-sm text-gray-600 mb-4">
                                    These charts visualize each supplier's performance across criteria. Positive values indicate performance above average for that criterion, negative values indicate below average.
                                </p>
                                {results.method === 'GAPS' && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {suppliers.map(s => (
                                            <div key={`radar-${s.id}`} className="bg-white p-4 rounded-lg shadow-md flex flex-col items-center">
                                                <h4 className="text-lg font-semibold text-gray-800 mb-2">{s.name}</h4>
                                                <RadarChart
                                                    supplierId={s.id}
                                                    criteria={allCriteria}
                                                    differenceMatrix={results.differenceMatrix}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                )}
                                {results.method === 'MABAC' && (
                                    <div className="mt-6 p-4 bg-blue-100 rounded-lg shadow-inner">
                                        <h4 className="text-lg font-semibold text-blue-700 mb-3">Visualize Performance by Criterion:</h4>
                                        <div className="mb-4">
                                            <label htmlFor="chart-criterion-select" className="block text-sm font-medium text-gray-700 mb-1">Select Criterion to Visualize:</label>
                                            <select
                                                id="chart-criterion-select"
                                                className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
                                                value={selectedCriterionForChart}
                                                onChange={(e) => setSelectedCriterionForChart(e.target.value)}
                                            >
                                                <option value="">-- Select a Criterion --</option>
                                                {allMabacCriteria.map(c => (
                                                    <option key={c.id} value={c.id}>{c.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                        {selectedCriterionForChart && (
                                            <HorizontalBarChartAcrossSuppliers
                                                selectedCriterionId={selectedCriterionForChart}
                                                allSuppliers={suppliers}
                                                allCriteria={allCriteria}
                                                gammaMatrix={results.gammaMatrix}
                                                chartTitle={`Performance for ${allCriteria.find(c => c.id === selectedCriterionForChart)?.name}`}
                                            />
                                        )}
                                    </div>
                                )}


                                {/* PDF Export Button */}
                                <div className="text-center mt-8">
                                    <button
                                        id="export-pdf-button"
                                        onClick={exportResultsToPdf}
                                        className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-md shadow-lg transform transition duration-300 ease-in-out hover:scale-105 flex items-center justify-center mx-auto"
                                    >
                                        <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                        Export Results to PDF
                                    </button>
                                </div>

                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const RadarChart = ({ supplierId, criteria, differenceMatrix }) => {
            const chartRef = React.useRef(null);
            const chartInstanceRef = React.useRef(null);

            React.useEffect(() => {
                if (!chartRef.current || !window.Chart) return;

                if (chartInstanceRef.current) {
                    chartInstanceRef.current.destroy();
                }

                const labels = criteria.map(c => c.name);
                const dataPoints = criteria.map(c => differenceMatrix[supplierId]?.[c.id] || 0);

                const ctx = chartRef.current.getContext('2d');
                chartInstanceRef.current = new window.Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Performance Score',
                            data: dataPoints,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(59, 130, 246, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                angleLines: {
                                    display: true
                                },
                                suggestedMin: -0.5,
                                suggestedMax: 0.5,
                                ticks: {
                                    beginAtZero: true,
                                    color: '#4b5563',
                                },
                                pointLabels: {
                                    color: '#1f2937',
                                    font: {
                                        size: 10
                                    }
                                },
                                grid: {
                                    color: 'rgba(209, 213, 219, 0.5)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.r !== null) {
                                            label += context.parsed.r.toFixed(4);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy();
                        chartInstanceRef.current = null;
                    }
                };
            }, [supplierId, criteria, differenceMatrix]);

            return <canvas ref={chartRef}></canvas>;
        };

        const HorizontalBarChartAcrossSuppliers = ({ selectedCriterionId, allSuppliers, allCriteria, gammaMatrix, chartTitle }) => {
            const chartRef = React.useRef(null);
            const chartInstanceRef = React.useRef(null);

            React.useEffect(() => {
                if (!chartRef.current || !window.Chart || !selectedCriterionId || !gammaMatrix) return;

                if (chartInstanceRef.current) {
                    chartInstanceRef.current.destroy();
                }

                const labels = allSuppliers.map(s => s.name);
                const dataPoints = allSuppliers.map(s => gammaMatrix[s.id]?.[selectedCriterionId] || 0);

                const ctx = chartRef.current.getContext('2d');
                chartInstanceRef.current = new window.Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: chartTitle,
                            data: dataPoints,
                            backgroundColor: dataPoints.map(val => val >= 0 ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)'),
                            borderColor: dataPoints.map(val => val >= 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: false,
                                min: -0.3,
                                max: 0.5,
                                ticks: {
                                    color: '#4b5563'
                                },
                                grid: {
                                    color: 'rgba(209, 213, 219, 0.5)'
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#1f2937'
                                },
                                grid: {
                                    color: 'rgba(209, 213, 219, 0.5)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.x !== null) {
                                            label += context.parsed.x.toFixed(4);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy();
                        chartInstanceRef.current = null;
                    }
                };
            }, [selectedCriterionId, allSuppliers, gammaMatrix, chartTitle]);

            return <canvas ref={chartRef}></canvas>;
        };


        // Render the React App
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
